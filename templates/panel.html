<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Demo</title>
    <link href="{{url_for('static', filename='layui/css/layui.css')}}" rel="stylesheet">
</head>

<style type="text/css">
    .site-border-default fieldset {
        border-top: 1px solid #eee;
    }

    .site-border-red fieldset {
        border-top: 1px solid #FF5722;
    }

    .site-border-orange fieldset {
        border-top: 1px solid #FFB800;
    }

    .site-border-green fieldset {
        border-top: 1px solid #009688;
    }

    .site-border-cyan fieldset {
        border-top: 1px solid #2F4056;
    }

    .site-border-blue fieldset {
        border-top: 1px solid #1E9FFF;
    }

    .site-border-black fieldset {
        border-top: 1px solid #393D49;
    }

    .label-div {
        display: inline-block;
        margin-top: 9px;
    }
</style>

<body>
    <div style="margin-left: 20%; margin-right: 20%; margin-top: 4%;">
        <div class="site-border-green">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend class="layui-font-green">请选择任务</legend>
            </fieldset>
        </div>
        <div class="layui-form" style="text-align: center;">
            <input type="radio" name="task" value="脑电帽迁移" title="脑电帽迁移" checked>
            <input type="radio" name="task" value="模态迁移" title="模态迁移">
            <input type="radio" name="task" value="范式迁移" title="范式迁移">
        </div>

        <div class="site-border-green">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend class="layui-font-green">请选择模型</legend>
            </fieldset>
        </div>
        <div class="layui-form">
            <div style="margin-left: 15%;">
                <div class="layui-row">
                    <div class="layui-col-md2">
                        <div class="grid-demo label-div"> 传统机器学习算法 </div>
                    </div>
                    <div class="layui-col-md2">
                        <input class="grid-demo" type="radio" name="model" value="LDA" title="LDA">
                    </div>
                    <div class="layui-col-md2">
                        <input class="grid-demo" type="radio" name="model" value="LR" title="LR">
                    </div>
                    <div class="layui-col-md2">
                        <input class="grid-demo" type="radio" name="model" value="AdaBoost" title="AdaBoost">
                    </div>
                    <div class="layui-col-md2">
                        <input class="grid-demo" type="radio" name="model" value="GBDT" title="GBDT">
                    </div>
                    <div class="layui-col-md2">
                        <input class="grid-demo" type="radio" name="model" value="XGB" title="XGB">
                    </div>
                </div>
                <div class="layui-row">
                    <div class="layui-col-md2">
                        <div class="grid-demo label-div"> 现有迁移学习算法 </div>
                    </div>
                    <div class="layui-col-md2">
                        <input class="grid-demo" type="radio" name="model" value="EEGNet" title="EEGNet">
                    </div>
                    <div class="layui-col-md2">
                        <input class="grid-demo" type="radio" name="model" value="DAN" title="DAN">
                    </div>
                    <div class="layui-col-md2">
                        <input class="grid-demo" type="radio" name="model" value="DANN" title="DANN">
                    </div>
                    <div class="layui-col-md2">
                        <input class="grid-demo" type="radio" name="model" value="JAN" title="JAN">
                    </div>
                    <div class="layui-col-md2">
                        <input class="grid-demo" type="radio" name="model" value="CDAN" title="CDAN">
                    </div>
                </div>
                <div class="layui-row">
                    <div class="layui-col-md2">
                        <div class="grid-demo label-div" style="opacity:0;"> 现有迁移学习算法 </div>
                    </div>
                    <div class="layui-col-md2">
                        <input class="grid-demo" type="radio" name="model" value="MDD" title="MDD">
                    </div>
                    <div class="layui-col-md2">
                        <input class="grid-demo" type="radio" name="model" value="MCC" title="MCC">
                    </div>
                    <div class="layui-col-md2">
                        <input class="grid-demo" type="radio" name="model" value="SHOT" title="SHOT">
                    </div>
                    <div class="layui-col-md2">
                        <input class="grid-demo" type="radio" name="model" value="ISFDA" title="ISFDA">
                    </div>
                </div>
                <div class="layui-row">
                    <div class="layui-col-md2">
                        <div class="grid-demo label-div"> 我们提出的算法 </div>
                    </div>
                    <div class="layui-col-md2">
                        <input class="grid-demo" type="radio" name="model" value="Ours" title="Ours" checked>
                    </div>
                </div>
            </div>
        </div>

        <div class="site-border-green">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend class="layui-font-green">请上传数据集</legend>
            </fieldset>
        </div>
        <div style="text-align:center; width:100%;">
            <table style="width:60%; margin:0 auto;">
                <tr>
                    <td>
                        <button id="source-upload" type="file" class="layui-btn test" lay-data="{url:'/b/', accept:'file', exts:'zip', auto:false, drag:true, acceptMime:'application/zip'}">
                            选择源域数据集(.zip)
                        </button>
                    </td>
                    <td>
                        <button id="target-upload" type="file" class="layui-btn test" lay-data="{url:'/b/', accept:'file', exts:'zip', auto:false, drag:true, acceptMime:'application/zip'}">
                            选择目标域数据集(.zip)
                        </button>
                    </td>
                </tr>
                <tr>
                    <td id="source-filename"></td>
                    <td id="target-filename"></td>
                </tr>
            </table>
        </div>

        <div class="site-border-green">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend class="layui-font-green">参数调节</legend>
            </fieldset>
        </div>
        <div class="layui-form layui-row">
            <div class="grid-demo layui-col-md1" style="margin-left: 6%; padding-right:1%; text-align: right;">
                <div class="label-div"> epoch </div>
            </div>
            <div class="grid-demo layui-col-md2" style="margin-right: 5%;">
                <select lay-search="" id="epoch">
                    <option value="50"> 50</option>
                    <option value="100">100</option>
                    <option value="150">150</option>
                    <option value="200">200</option>
                    <option value="300">300</option>
                </select>
            </div>

            <div class="grid-demo layui-col-md1" style="padding-right:1%; text-align: right;">
                <div class="label-div"> batchsize </div>
            </div>
            <div class="grid-demo layui-col-md2" style="margin-right: 5%;">
                <select lay-search="" id="batchsize">
                    <option value="8"> 8</option>
                    <option value="16">16</option>
                    <option value="32">32</option>
                    <option value="64">64</option>
                </select>
            </div>

            <div class="grid-demo layui-col-md1" style="padding-right:1%; text-align: right;">
                <div class="grid-demo label-div"> 优化器 </div>
            </div>
            <div class="grid-demo layui-col-md2">
                <select lay-search="" id="optimizer">
                    <option value="SGD">SGD</option>
                    <option value="Adam">Adam</option>
                </select>
            </div>
        </div>

        <div class="layui-form" style="text-align: center; margin-top: 1%;">
            <input type="checkbox" name="EASwitch" title="启用EA|关闭EA" lay-skin="switch" lay-filter="EASwitch-filter">
            <button type="button" id="EADisplayButton" class="layui-btn layui-btn-primary" lay-on="ea-layer" style="margin-left: 15%;">
                查看对齐效果
            </button>
        </div>
        <!-- <div style="display: inline-block; margin-top: 20px;">查看对齐效果</div> -->
        <br>
        <div style="width: 80%; margin-left: 10%; margin-right: 10%; margin-top: 3%;">
            <button type="button" class="layui-btn layui-btn-fluid" lay-active="run">运行</button>
        </div>
    </div>
</body>

<script src="{{url_for('static', filename='layui/layui.js')}}"></script>
<script>
    var $ = layui.$;
    var data = JSON.parse(sessionStorage.getItem('data'));
    data = (data ? data : {source:'', target:''});
    // if (data === null) {
    //     data = {source:'', target:''};
    // }
    function getData() {
        return {
            task: $("input[name='task']:checked").val(),
            model: $("input[name='model']:checked").val(),
            epoch: $('#epoch').val(),
            batchsize: $('#batchsize').val(),
            optimizer: $('#optimizer').val(),
            ea: $("input[name='EASwitch']").is(":checked"),
            source: data.source,
            target: data.target,
        };
    }
    // window.onbeforeunload = function() {	
    //     sessionStorage.clear();
    // }
    
    layui.use(function () {
        var upload = layui.upload;
        var layer = layui.layer;
        var util = layui.util;
        var form = layui.form;

        $('#panelLi', window.parent.document).addClass('layui-this').siblings().removeClass('layui-this');
        // console.log(data);
        if (data) {
            $("input:radio[name='task'][value='" + data.task + "']").prop("checked", true);
            $("input:radio[name='model'][value='" + data.model + "']").prop("checked", true);
            $("[id='epoch']").val(data.epoch);
            $("[id='batchsize']").val(data.batchsize);
            $("[id='optimizer']").val(data.optimizer);
            if (data.ea) {
                $("input[name='EASwitch']").attr("checked", true);
            } else {
                $("input[name='EASwitch']").removeAttr("checked");
            }
            $("[id='source-filename']").text(data.source);
            $("[id='target-filename']").text(data.target);
            form.render();
        }

        upload.render({
            elem: "[type='file']",
            auto: false,
            choose: function(obj){
                // var files = obj.pushFile(); // 将每次选择的文件追加到文件队列
                let id = this.elem.attr("id");
                // 预读本地文件，如果是多文件，则会遍历。(不支持ie8/9)
                obj.preview(function(index, file, result){
                    if (id == 'source-upload') {
                        $("[id='source-filename']").text(file.name);
                        data.source = file.name;
                    } else {
                        $("[id='target-filename']").text(file.name);
                        data.target = file.name;
                    }
                });
            }
        });

        util.on('lay-on', {
            'ea-layer': function(){
                let source = data.source.slice(0,-4);                
                let target = data.target.slice(0,-4);                
                layer.open({
                    type: 1,
                    offset: 'r',
                    anim: 'slideLeft', // 从右往左
                    area: ['40%', '100%'],
                    shade: 0.1,
                    shadeClose: true,
                    title: "<span style='font-size: 24px; font-weight: bold; color: #333; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); transition: all 0.3s;'>对齐结果演示</span>",
                    // title: "对齐结果演示",
                    // id: 'ID-demo-layer-direction-r',
                    content: "<h2 style='margin-top:15px; margin-left:15px'>源域数据集</h2>" + (source ? "<div style='text-align:center; margin-bottom:45px;'> <img src='static/panel/" + source + "_subjects.png' style='width:80%;'> <br> <span style='text-align:center; font-size:22px;'><strong>图1 BNCI2014001数据集EA操作对齐前</strong></span> </div> <div style='text-align:center; margin-bottom:45px;'> <img src='static/panel/" + source + "_EA_subjects.png' style='width:80%;'> <br> <span style='text-align:center; font-size:22px;'><strong>图2 BNCI2014001数据集EA操作对齐后</strong></span> </div>" : "<div style='text-align:center; color:red;'>请选择源域数据集</div>") + "<h2 style='margin-top:15px; margin-left:15px'>目标域数据集</h2>" + (target ? "<div style='text-align:center; margin-bottom:45px;'> <img src='static/panel/" + target + "_subjects.png' style='width:80%;'> <br> <span style='text-align:center; font-size:22px;'><strong>图3 BNCI2014004数据集EA操作对齐前</strong></span> </div> <div style='text-align:center; margin-bottom:45px;'> <img src='static/panel/" + target + "_EA_subjects.png' style='width:80%;'> <br> <span style='text-align:center; font-size:22px;'><strong>图4 BNCI2014004数据集EA操作对齐后</strong></span> </div>" : "<div style='text-align:center; color:red;'>请选择目标域数据集</div>"),
                });
            },
        });

        util.event('lay-active', {
            run: function () {
                data = getData();
                sessionStorage.setItem('data', JSON.stringify(data));

                if (data.source == '' || data.target == '') {
                    layer.open({
                        title: '提示',
                        content: '请选择数据集',
                    });
                    return;
                }

                $.ajax({
                    url: '/run',
                    data: data,
                    dataType: 'text',
                    type: 'post',
                    success: function (data) {
                        if (data == 'true') {
                            $("#body", window.parent.document).attr("src", "{{url_for('result')}}");
                            // $("div[class='layui-body']").innerHTML = "<iframe id='body' width='100%' height='100%' src=''></iframe>";
                            // console.log('data');
                        } else {
                            layer.open({
                                title: '提示',
                                content: data,
                            });
                        }
                    },
                });
            }
        });
    });
</script>
</body>
</html>